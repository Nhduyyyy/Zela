@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>@ViewData["Title"] - Zela</title>

    <!-- CSS -->
    <link rel="stylesheet" href="~/css/base/normalize.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>
    
    <!-- Bootstrap PHẢI ĐƯỢC LOAD TRƯỚC để không đè lên CSS custom -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css"/>
    
    <!-- Theme và CSS chính - LOAD SAU Bootstrap để override -->
    <link rel="stylesheet" href="~/css/themes/chat-theme.css" />
    <!-- Force CSS variables load -->
    <link rel="stylesheet" href="~/css/layout/sidebar.css"/>
    <link rel="stylesheet" href="~/css/components/profile-dialog.css"/>
    <link rel="stylesheet" href="~/css/components/sidebar-media.css"/>
    <link rel="stylesheet" href="~/css/video-call-popup.css"/>
    <link rel="stylesheet" href="~/css/pages/chat/_reactions.css"/>

    @RenderSection("Styles", required: false)

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body style="margin:0;">
<!-- Hidden anti-forgery token for JavaScript -->
@Html.AntiForgeryToken()
<!-- SIDEBAR ZELA -->
<div class="zela-layout">
    <aside class="zela-sidebar">
        <!-- User Avatar Section -->
        @if (Context.Session.GetInt32("UserId") != null)
        {
            <div class="zela-user-section">
                <div class="user-avatar-container" onclick="openProfileDialog()" title="Click để xem hồ sơ">
                    <img src="@(Context.Session.GetString("AvatarUrl") ?? "/images/default-avatar.jpeg")"
                         alt="Avatar"
                         class="user-avatar-sidebar rounded-circle header-avatar"/>
                    <div class="user-status-indicator"></div>
                </div>
                <div class="user-info">
                    <div class="user-name">@(Context.Session.GetString("FullName") ?? "User")</div>
                </div>
                <div class="user-actions">
                    <div class="dropdown">
                        <button class="btn-pro btn-link user-menu-btn" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="openProfileDialog(); return false;">
                                    <i class="bi bi-person me-2"></i>
                                    Hồ sơ của bạn
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-controller="Payment" asp-action="Plans">
                                    <i class="bi bi-crown me-2"></i>
                                    Nâng cấp Premium
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="bi bi-gear me-2"></i>
                                    Cài đặt
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <form asp-controller="Account" asp-action="Logout" method="post" class="dropdown-form">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right me-2"></i>
                                        Đăng xuất
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        }
        <nav class="zela-nav">
            <ul>
                <li>
                    <a class="nav-link" asp-controller="Chat" asp-action="Index">
                        <i class="bi bi-chat-dots"></i>
                        <span class="nav-label">Chat</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Friendship" asp-action="Index">
                        <i class="bi bi-people"></i>
                        <span class="nav-label">Friendship</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Meeting" asp-action="Index">
                        <i class="bi bi-camera-video"></i>
                        <span class="nav-label">Video Call</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Meeting" asp-action="Recordings">
                        <i class="bi bi-collection-play"></i>
                        <span class="nav-label">Recordings</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Whiteboard" asp-action="Index">
                        <i class="bi bi-easel"></i>
                        <span class="nav-label">Whiteboard</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Quiz" asp-action="Index">
                        <i class="bi bi-ui-checks"></i>
                        <span class="nav-label">Quiz</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="AI" asp-action="Index">
                        <i class="bi bi-stars"></i>
                        <span class="nav-label">AI Assistant</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Admin" asp-action="Index">
                        <i class="bi bi-graph-up"></i>
                        <span class="nav-label">Analytics</span>
                    </a>
                </li>
                <li>
                    <a class="nav-link" asp-controller="Notification" asp-action="Index">
                        <i class="bi bi-bell"></i>
                        <span class="nav-label">Thông báo</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="zela-footer">
            <form asp-controller="Account" asp-action="Logout" method="post">
                @Html.AntiForgeryToken()
                <button type="submit" class="logout-btn" title="Đăng xuất">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </form>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="zela-main">
        @RenderBody()
    </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
<script src="~/js/profile-dialog.js"></script>
<script src="~/js/message-reactions.js"></script>
<script src="~/js/group-sidebar.js"></script>

@await RenderSectionAsync("Scripts", required: false)
<script>
    // Global toast function
    window.showToast = function(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Show toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    };

    $(document).ready(function () {
        // Initialize all dropdowns
        var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'))
        var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl)
        });

        console.log('jQuery version:', $.fn.jquery);
        console.log('Bootstrap version:', $.fn.modal ? 'Loaded' : 'Not loaded');
        console.log('Session UserId:', @Context.Session.GetInt32("UserId"));
    });
</script>

<!-- Profile Dialog -->
@if (Context.Session.GetInt32("UserId") != null)
{
    @await Html.PartialAsync("_ProfileDialog", new Zela.ViewModels.ProfileViewModel())
}

<!-- Reaction Menu Modal -->
<div id="reactionMenu" class="reaction-menu" style="display: none;">
    <div class="reaction-menu-content">
        <div class="reaction-option" data-reaction="Like">
            <span class="reaction-emoji">👍</span>
            <span class="reaction-label">Like</span>
        </div>
        <div class="reaction-option" data-reaction="Love">
            <span class="reaction-emoji">❤️</span>
            <span class="reaction-label">Love</span>
        </div>
        <div class="reaction-option" data-reaction="Haha">
            <span class="reaction-emoji">😂</span>
            <span class="reaction-label">Haha</span>
        </div>
        <div class="reaction-option" data-reaction="Wow">
            <span class="reaction-emoji">😮</span>
            <span class="reaction-label">Wow</span>
        </div>
        <div class="reaction-option" data-reaction="Sad">
            <span class="reaction-emoji">😢</span>
            <span class="reaction-label">Sad</span>
        </div>
        <div class="reaction-option" data-reaction="Angry">
            <span class="reaction-emoji">😠</span>
            <span class="reaction-label">Angry</span>
        </div>
    </div>
</div>
</body>
</html>