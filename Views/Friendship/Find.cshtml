@using Zela.ViewModels
@model IEnumerable<Zela.ViewModels.UserWithFriendshipStatus>
@{
    ViewData["Title"] = "üîç T√¨m b·∫°n m·ªõi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/friend-find.css" />
}

<div class="container">
    <h2>
        <span style="display: block; font-size: 0.6em; color: #718096; font-weight: 500; margin-bottom: 0.5rem;">K·∫øt n·ªëi & K·∫øt b·∫°n</span>
        üîç T√¨m b·∫°n m·ªõi
    </h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger" role="alert">
            <strong>‚ö†Ô∏è Oops!</strong> @TempData["Error"]
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success" role="alert" style="background: linear-gradient(135deg, rgba(56, 161, 105, 0.1), rgba(72, 187, 120, 0.1)); border: 1px solid rgba(56, 161, 105, 0.3); color: #38a169; border-radius: 16px; padding: 1rem 1.5rem; border-left: 4px solid #38a169; font-weight: 500;">
            <strong>‚úÖ Th√†nh c√¥ng!</strong> @TempData["Success"]
        </div>
    }

    <!-- üîç Search Section -->
    <div class="search-section mb-4">
        <div class="search-container">
            <input type="text" id="searchInput" class="form-control" 
                   placeholder="üí≠ Nh·∫≠p t√™n ho·∫∑c email ƒë·ªÉ t√¨m ki·∫øm b·∫°n b√®..." 
                   autocomplete="off" />
        </div>
        <div class="search-stats mt-2 text-center">
            <small class="text-muted">
                <span id="searchCount">@Model.Count()</span> ng∆∞·ªùi d√πng ƒë∆∞·ª£c t√¨m th·∫•y
            </small>
        </div>
    </div>

    <!-- üîΩ Results Section -->
    <div class="results-section" id="searchResults">
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-id-badge"></i> ID</th>
                            <th><i class="fas fa-user"></i> T√™n ng∆∞·ªùi d√πng</th>
                            <th><i class="fas fa-users"></i> B·∫°n chung</th>
                            <th><i class="fas fa-heart"></i> Tr·∫°ng th√°i k·∫øt b·∫°n</th>
                            <th><i class="fas fa-cogs"></i> H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        @{int fakeId = 1;}
                        @foreach (var user in Model)
                        {
                            <tr data-user-id="@user.UserId" data-username="@user.UserName.ToLower()" data-fake-id="@fakeId">
                                <td>
                                    <span class="user-id">#@fakeId</span>
                                </td>
                                <td>
                                    <div class="user-info">
                                        <div class="user-avatar">
                                            <img src="~/images/default-avatar.jpeg" alt="@user.UserName" class="avatar-img">
                                        </div>
                                        <div class="user-details">
                                            <strong>@user.UserName</strong>
                                            <small class="d-block text-muted" title="@user.Email">@user.Email</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (user.MutualFriendsCount > 0)
                                    {
                                        <span class="mutual-friends-badge" 
                                              data-user-id="@user.UserId" 
                                              data-user-name="@user.UserName"
                                              style="cursor: pointer;"
                                              title="Nh·∫•n ƒë·ªÉ xem danh s√°ch b·∫°n chung">
                                            <i class="fas fa-users text-primary"></i>
                                            <strong class="text-primary">@user.MutualFriendsCount</strong>
                                            <small class="text-muted">b·∫°n chung</small>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">
                                            <i class="fas fa-users"></i> Kh√¥ng c√≥
                                        </span>
                                    }
                                </td>
                                <td>
                                    @switch (user.Role)
                                    {
                                        case FriendshipRole.None:
                                            <span class="text-muted">
                                                <i class="fas fa-user-plus"></i> Ch∆∞a k·∫øt b·∫°n
                                            </span>
                                            break;
                                        case FriendshipRole.PendingSent:
                                            <span class="text-info">
                                                <i class="fas fa-clock"></i> ƒê√£ g·ª≠i l·ªùi m·ªùi
                                            </span>
                                            break;
                                        case FriendshipRole.PendingReceived:
                                            <span class="text-warning">
                                                <i class="fas fa-envelope"></i> C√≥ l·ªùi m·ªùi ƒë·∫øn
                                            </span>
                                            break;
                                        case FriendshipRole.Accepted:
                                            <span class="text-success">
                                                <i class="fas fa-check-circle"></i> ƒê√£ l√† b·∫°n
                                            </span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        @switch (user.Role)
                                        {
                                            case FriendshipRole.None:
                                                <form asp-action="SendRequest" method="post" class="mb-0">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="userId2" value="@user.UserId" />
                                                    <button type="submit" class="btn btn-sm btn-primary" title="G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n">
                                                        <i class="fas fa-user-plus"></i> K·∫øt b·∫°n
                                                    </button>
                                                </form>
                                                break;
                                            case FriendshipRole.PendingSent:
                                                <span class="text-secondary status-waiting">
                                                    <i class="fas fa-hourglass-half"></i> ƒêang ch·ªù ph·∫£n h·ªìi
                                                </span>
                                                break;
                                            case FriendshipRole.PendingReceived:
                                                <div class="btn-group-vertical" style="gap: 0.5rem;">
                                                    <form asp-action="AcceptRequest" method="post" class="mb-0">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="requesterId" value="@user.UserId" />
                                                        <button type="submit" class="btn btn-sm btn-success" title="Ch·∫•p nh·∫≠n l·ªùi m·ªùi">
                                                            <i class="fas fa-check"></i> Ch·∫•p nh·∫≠n
                                                        </button>
                                                    </form>
                                                    <form asp-action="RejectRequest" method="post" class="mb-0">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="requesterId" value="@user.UserId" />
                                                        <button type="submit" class="btn btn-sm btn-secondary" title="T·ª´ ch·ªëi l·ªùi m·ªùi">
                                                            <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                                        </button>
                                                    </form>
                                                </div>
                                                break;
                                            case FriendshipRole.Accepted:
                                                <div class="btn-group" style="gap: 0.5rem;">
                                                    <a href="@Url.Action("Index", "Chat", new { friendId = user.UserId })" 
                                                       class="btn btn-sm btn-chat" 
                                                       title="Nh·∫Øn tin v·ªõi @user.UserName">
                                                        <i class="fas fa-comment-dots"></i>
                                                        <span>Chat</span>
                                                    </a>
                                                    <form asp-action="RemoveFriend" method="post" class="mb-0">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="friendId" value="@user.UserId" />
                                                        <button type="submit" class="btn btn-sm btn-danger" 
                                                                title="H·ªßy k·∫øt b·∫°n"
                                                                onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy k·∫øt b·∫°n v·ªõi @user.UserName?')">
                                                            <i class="fas fa-user-times"></i> H·ªßy b·∫°n
                                                        </button>
                                                    </form>
                                                </div>
                                                break;
                                        }
                                    </div>
                                </td>
                            </tr>
                            fakeId++;
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="icon">üë•</div>
                <h4>Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</h4>
                <p>H√£y th·ª≠ t√¨m ki·∫øm ho·∫∑c quay l·∫°i sau ƒë·ªÉ kh√°m ph√° th√™m b·∫°n b√® m·ªõi!</p>
            </div>
        }
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center" style="display: none;">
        <div class="loading"></div>
        <p class="mt-3 text-muted">ƒêang t√¨m ki·∫øm...</p>
    </div>

    <!-- No Results State -->
    <div id="noResultsState" class="empty-state" style="display: none;">
        <div class="icon">üîç</div>
        <h4>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
        <p>H√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ki·ªÉm tra l·∫°i ch√≠nh t·∫£.</p>
    </div>

    <!-- Navigation -->
    <div class="text-center mt-5">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay v·ªÅ danh s√°ch b·∫°n b√®
        </a>
        <a href="#" class="btn btn-primary ms-3" onclick="window.location.reload()">
            <i class="fas fa-sync-alt"></i> L√†m m·ªõi
        </a>
    </div>
</div>

@section Scripts {
    <script src="~/js/friend-search.js"></script>
    <script src="~/js/mutual-friends.js"></script>
}
