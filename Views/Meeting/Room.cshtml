@{
    ViewData["Title"] = "Video Call Room";
}

<link href="~/css/pages/room-videocall.css" rel="stylesheet" />

<div class="videocall-container">
    <h2>ğŸ¥ PhÃ²ng há»p: @ViewBag.meetingName</h2>
    
    <div class="meeting-code-container">
        <input type="text" id="meeting-code-input" value="@ViewBag.code" readonly>
        <button id="copy-code-btn">Copy mÃ£ phÃ²ng</button>
    </div>

    <div id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-message">Äang káº¿t ná»‘i...</p>
        </div>
    </div>

    <div id="error-notification" style="display: none;">
        <div class="error-content">
            <span class="error-icon">âš ï¸</span>
            <span class="error-message">CÃ³ lá»—i xáº£y ra</span>
            <button class="error-close">&times;</button>
        </div>
    </div>

    <div id="connection-status" class="connection-status connecting">
        <span class="status-icon">ğŸ”„</span>
        <span class="status-text">Äang káº¿t ná»‘i...</span>
    </div>

    <div id="controls">
        <button id="toggle-mic" class="btn">ğŸ¤ Micro</button>
        <button id="toggle-cam" class="btn">ğŸ“¹ Camera</button>
        <button id="share-screen" class="btn">ğŸ–¥ï¸ Chia sáº» mÃ n hÃ¬nh</button>
        <button id="toggle-quality" class="btn btn-info">âš™ï¸ Cháº¥t lÆ°á»£ng</button>
        <button id="toggle-recording" class="btn btn-success">ğŸ¥ Ghi hÃ¬nh</button>
        <button id="toggle-stats" class="btn btn-info">ğŸ“Š Xem thá»‘ng kÃª</button>
        <button id="btnLeave" class="btn" onclick="window.location.href='/Meeting'">ğŸšª Rá»i phÃ²ng</button>
        <button id="btnEnd" class="btn" onclick="if(confirm('Báº¡n cÃ³ muá»‘n káº¿t thÃºc cuá»™c há»p?')) window.location.href='/Meeting'">ğŸ”š Káº¿t thÃºc</button>
    </div>

    <div id="video-grid"></div>

    <!-- Stats Sidebar -->
    <div id="stats-sidebar" class="stats-sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“Š Thá»‘ng kÃª cuá»™c há»p</h3>
            <button id="close-stats" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="stats-loading" class="loading-spinner">
                <div class="spinner"></div>
                <p>Äang táº£i thá»‘ng kÃª...</p>
            </div>
            <div id="stats-data" class="stats-data" style="display: none;">
                <!-- Stats content will be loaded here -->
            </div>
            <div id="stats-error" class="error-message" style="display: none;">
                <p>âŒ KhÃ´ng thá»ƒ táº£i thá»‘ng kÃª</p>
                <button id="retry-stats" class="btn btn-sm btn-primary">Thá»­ láº¡i</button>
            </div>
        </div>
    </div>

    <!-- Quality Control Sidebar -->
    <div id="quality-sidebar" class="stats-sidebar quality-sidebar">
        <div class="sidebar-header">
            <h3>âš™ï¸ Cháº¥t lÆ°á»£ng Video</h3>
            <button id="close-quality" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="quality-content">
                <!-- Quality control content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Recording Sidebar -->
    <div id="recording-sidebar" class="stats-sidebar recording-sidebar">
        <div class="sidebar-header">
            <h3>ğŸ¥ Ghi hÃ¬nh & Chá»¥p áº£nh</h3>
            <button id="close-recording" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="recording-content">
                <!-- Recording content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script>
        // Set global variables for recording system
        window.meetingCode = '@ViewBag.code';
        
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('copy-code-btn');
            const input = document.getElementById('meeting-code-input');
            btn.addEventListener('click', () => {
                input.select();
                document.execCommand('copy');
                btn.textContent = 'ÄÃ£ copy!';
                setTimeout(() => btn.textContent = 'Copy mÃ£ phÃ²ng', 2000);
            });

            // Reset button states on page load
            const qualityBtn = document.getElementById('toggle-quality');
            const recordingBtn = document.getElementById('toggle-recording');
            const statsBtn = document.getElementById('toggle-stats');
            
            if (qualityBtn) {
                qualityBtn.innerHTML = 'âš™ï¸ Cháº¥t lÆ°á»£ng';
                qualityBtn.classList.remove('active');
            }
            
            if (recordingBtn) {
                recordingBtn.innerHTML = 'ğŸ¥ Ghi hÃ¬nh';
                recordingBtn.classList.remove('active');
            }
            
            if (statsBtn) {
                statsBtn.innerHTML = 'ğŸ“Š Xem thá»‘ng kÃª';
                statsBtn.classList.remove('active');
            }
            
            // Ensure all sidebars are closed initially
            const qualitySidebar = document.getElementById('quality-sidebar');
            const recordingSidebar = document.getElementById('recording-sidebar');
            const statsSidebar = document.getElementById('stats-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (qualitySidebar) qualitySidebar.classList.remove('open');
            if (recordingSidebar) recordingSidebar.classList.remove('open');
            if (statsSidebar) statsSidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');

            // Initialize sidebar systems after a short delay to ensure DOM is ready
            setTimeout(() => {
                // Initialize quality control system
                if (typeof initializeQualityControl === 'function') {
                    window.qualityController = initializeQualityControl();
                    console.log('âœ… Quality Control System initialized');
                }
                
                // Initialize recording system
                if (typeof initializeRecordingSystem === 'function') {
                    window.recordingSystem = initializeRecordingSystem();
                    console.log('âœ… Recording System initialized');
                }
            }, 500);
        });
    </script>
    
    <!-- Main video call script - Load FIRST -->
    <script src="~/js/videocall.js"></script>
    
    <!-- Quality Control System -->
    <script src="~/js/quality-control.js"></script>
    
    <!-- Recording & Screenshots System -->
    <script src="~/js/recording-system.js"></script>
    
    <!-- Stats Sidebar System -->
    <script src="~/js/stats-sidebar.js"></script>
}