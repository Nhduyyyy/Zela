@{
// Äáº·t tiÃªu Ä‘á» trang, sáº½ hiá»ƒn thá»‹ trÃªn tab trÃ¬nh duyá»‡t hoáº·c header cá»§a layout
ViewData["Title"] = "Video Call Room";
}

@* Section Styles: ChÃ¨n CSS riÃªng cho trang nÃ y vÃ o layout tá»•ng thá»ƒ (náº¿u layout cÃ³ @RenderSection("Styles")) *@
@section Styles {
<!-- Load CSS chÃ­nh cho toÃ n bá»™ trang video call -->
<link href="~/css/pages/room-videocall.css" rel="stylesheet" />
<!-- Load CSS cho chat panel -->
<link href="~/css/components/meeting-chat-panel.css" rel="stylesheet" />
<style>
    /* Äá»‹nh dáº¡ng cho badge "Host" (ngÆ°á»i chá»§ phÃ²ng) */
    .host-badge {
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 10px;
        box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        animation: glow 2s ease-in-out infinite alternate;
    }

    /* Äá»‹nh dáº¡ng cho badge "Tham gia" (ngÆ°á»i tham dá»±) */
    .participant-badge {
        background: linear-gradient(135deg, #4a90e2, #357abd);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 10px;
        box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
    }

    /* âœ¨ GLOW ANIMATION - Hiá»‡u á»©ng phÃ¡t sÃ¡ng cho host badge */
    /* ChÃº Ã½: DÃ¹ng @@ trong Razor Ä‘á»ƒ escape thÃ nh a trong CSS output */
    @@keyframes glow {
        from {
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }

        to {
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.6);
        }
    }
</style>
}

<div class="videocall-container">
    <!-- TiÃªu Ä‘á» phÃ²ng há»p, hiá»ƒn thá»‹ tÃªn phÃ²ng vÃ  badge phÃ¢n biá»‡t host/tham gia -->
    <h2>ğŸ¥ PhÃ²ng há»p: @ViewBag.meetingName
        @if (ViewBag.IsHost == true)
        {
        <span class="host-badge">ğŸ‘‘ Host</span>
        }
        else
        {
        <span class="participant-badge">ğŸ‘¤ Tham gia</span>
        }
    </h2>

    <!-- Hiá»ƒn thá»‹ mÃ£ phÃ²ng vÃ  nÃºt copy mÃ£ phÃ²ng -->
    <div class="meeting-code-container">
        <!-- Input readonly hiá»ƒn thá»‹ mÃ£ phÃ²ng tá»« ViewBag.code 
                        ID: meeting-code-input â†’ JavaScript sáº½ dÃ¹ng Ä‘á»ƒ select text khi copy -->
        <input type="text" id="meeting-code-input" value="@ViewBag.code" readonly>
        <!-- Button copy mÃ£ phÃ²ng vÃ o clipboard
                 ID: copy-code-btn â†’ JavaScript attach click event -->
        <button id="copy-code-btn">Copy mÃ£ phÃ²ng</button>
    </div>

    <!-- =========================================
     LOADING & ERROR LAYERS TRÃŠN MÃ€N HÃŒNH ROOM
     ========================================= -->

    <!-- 1ï¸âƒ£  LOADING OVERLAY  ---------------------------------
     â€¢ ID:    loading-overlay        (JS: showLoading / hideLoading)
     â€¢ Task:  Che toÃ n bá»™ mÃ n hÃ¬nh + spinner + thÃ´ng bÃ¡o
     â€¢ Máº·c Ä‘á»‹nh (CSS): display: none  â†’ áº©n ngay khi page render
     â€¢ Khi JS gá»i  showLoading()  â†’ display: flex (hiá»‡n)
     â€¢ Khi JS gá»i  hideLoading()  â†’ display: none (áº©n)
--------------------------------------------------------->
    <div id="videocall-loading-overlay" class="videocall-loading-overlay">
        <div class="videocall-loading-content">
            <div class="videocall-loading-spinner"></div>
            <p class="videocall-loading-message">Äang káº¿t ná»‘i...</p>
        </div>
    </div>
    <!-- 2ï¸âƒ£  ERROR NOTIFICATION  -------------------------------
     â€¢ ID:    error-notification     (JS: showError / hideError)
     â€¢ Task:  Toast cáº£nh bÃ¡o gÃ³c pháº£i â†’ bÃ¡o lá»—i cho user
     â€¢ Inline style â€œdisplay: noneâ€   â†’ áº©n máº·c Ä‘á»‹nh
     â€¢ Khi JS gá»i  showError(msg)     â†’ display: block + Ä‘á»•i ná»™i dung
     â€¢ Khi JS gá»i  hideError()        â†’ display: none
--------------------------------------------------------->
    <div id="error-notification" style="display: none;">
        <div class="error-content">
            <span class="error-icon">âš ï¸</span>
            <span class="error-message">CÃ³ lá»—i xáº£y ra</span> <!-- text Ä‘Æ°á»£c JS ghi Ä‘Ã¨ -->
            <button class="error-close">&times;</button> <!-- onclick="hideError()" -->
        </div>
    </div>

    <!-- Hiá»ƒn thá»‹ tráº¡ng thÃ¡i káº¿t ná»‘i -->
    <div id="connection-status" class="connection-status connecting">
        <span class="status-icon">ğŸ”„</span>
        <span class="status-text">Äang káº¿t ná»‘i...</span>
    </div>

    <!-- CÃ¡c nÃºt Ä‘iá»u khiá»ƒn phÃ²ng há»p -->
    <div id="controls">
        <button id="toggle-mic" class="btn">ğŸ¤ Micro</button>
        <button id="toggle-cam" class="btn">ğŸ“¹ Camera</button>
        <button id="share-screen" class="btn">ğŸ–¥ï¸ Chia sáº» mÃ n hÃ¬nh</button>
        <button id="toggle-chat" class="btn btn-primary">ğŸ’¬ Chat</button>
        <button id="toggle-subtitles" class="btn btn-secondary">ğŸ“ Phá»¥ Ä‘á»</button>
        <button id="toggle-quality" class="btn btn-info">âš™ï¸ Cháº¥t lÆ°á»£ng</button>
        <button id="toggle-recording" class="btn btn-success">ğŸ¥ Ghi hÃ¬nh</button>
        <button id="toggle-whiteboard" class="btn btn-warning">ğŸ¨ Whiteboard</button>
        @if (ViewBag.IsHost == true)
        {
        <button id="toggle-stats" class="btn btn-info">ğŸ“Š Xem thá»‘ng kÃª</button>
        }
        <button id="btnLeave" class="btn" onclick="window.location.href='/Meeting'">ğŸšª Rá»i phÃ²ng</button>
        @if (ViewBag.IsHost == true)
        {
        <button id="btnEnd" class="btn"
                onclick="if(confirm('Báº¡n cÃ³ muá»‘n káº¿t thÃºc cuá»™c há»p cho táº¥t cáº£ má»i ngÆ°á»i?')) window.location.href='/Meeting'">ğŸ”š
            Káº¿t thÃºc cuá»™c há»p</button>
        }
    </div>

    <!-- Khu vá»±c hiá»ƒn thá»‹ video call, cÃ¡c video sáº½ Ä‘Æ°á»£c JS render Ä‘á»™ng -->
    <div id="video-grid" data-meeting-code="@ViewBag.code" data-user-id="@ViewBag.UserId" data-room-id="1" data-session-id="@Guid.NewGuid()"></div>

    <!-- Sidebar thá»‘ng kÃª cuá»™c há»p (chá»‰ host má»›i xem Ä‘Æ°á»£c) -->
    <div id="stats-sidebar" class="stats-sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“Š Thá»‘ng kÃª cuá»™c há»p</h3>
            <button id="close-stats" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="stats-loading" class="loading-spinner">
                <div class="spinner"></div>
                <p>Äang táº£i thá»‘ng kÃª...</p>
            </div>
            <div id="stats-data" class="stats-data" style="display: none;">
                <!-- Ná»™i dung thá»‘ng kÃª sáº½ Ä‘Æ°á»£c JS load vÃ o Ä‘Ã¢y -->
            </div>
            <div id="stats-error" class="error-message" style="display: none;">
                <p>âŒ KhÃ´ng thá»ƒ táº£i thá»‘ng kÃª</p>
                <button id="retry-stats" class="btn btn-sm btn-primary">Thá»­ láº¡i</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Ä‘iá»u chá»‰nh cháº¥t lÆ°á»£ng video -->
    <div id="quality-sidebar" class="stats-sidebar quality-sidebar">
        <div class="sidebar-header">
            <h3>âš™ï¸ Cháº¥t lÆ°á»£ng Video</h3>
            <button id="close-quality" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="quality-content">
                <!-- Sidebar Ä‘iá»u chá»‰nh cháº¥t lÆ°á»£ng video -->
            </div>
        </div>
    </div>

    <!-- Sidebar quáº£n lÃ½ ghi hÃ¬nh, chá»¥p áº£nh -->
    <div id="recording-sidebar" class="stats-sidebar recording-sidebar">
        <div class="sidebar-header">
            <h3>ğŸ¥ Ghi hÃ¬nh & Chá»¥p áº£nh</h3>
            <button id="close-recording" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="recording-content">
                <!-- Ná»™i dung ghi hÃ¬nh sáº½ Ä‘Æ°á»£c JS load vÃ o Ä‘Ã¢y -->
            </div>
        </div>
    </div>

    <!-- Sidebar chat -->
    <div id="chat-sidebar" class="stats-sidebar chat-sidebar">
        <div class="sidebar-header">
            <h3>ğŸ’¬ Chat</h3>
            <button id="close-chat" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="chat-content">
                <!-- Chat panel sáº½ Ä‘Æ°á»£c load vÃ o Ä‘Ã¢y -->
            </div>
        </div>
    </div>

    <!-- Lá»›p phá»§ khi sidebar má»Ÿ -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Khu vá»±c báº£ng tráº¯ng (whiteboard), áº©n/hiá»‡n báº±ng JS -->
    <div id="whiteboard-container" class="whiteboard-container" style="display: none;">
        <!-- Ná»™i dung whiteboard sáº½ Ä‘Æ°á»£c JS load vÃ o Ä‘Ã¢y -->
    </div>
</div>

@section Scripts {
@* ÄÃ£ load SignalR á»Ÿ _Layout.cshtml *@
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
    // Äáº·t cÃ¡c biáº¿n toÃ n cá»¥c cho há»‡ thá»‘ng video call, ghi hÃ¬nh, quyá»n host
    window.meetingCode = '@ViewBag.code';
    window.currentUserId = @ViewBag.UserId;
    window.isHost = @(ViewBag.IsHost?.ToString().ToLower() ?? "false");

    document.addEventListener('DOMContentLoaded', () => {

        // ============================================
        // COPY MEETING CODE FUNCTIONALITY
        // ============================================

        // 1. Láº¤Y REFERENCES Äáº¾N DOM ELEMENTS
        // TÃ¬m button copy theo ID Ä‘á»ƒ attach event listener
        const btn = document.getElementById('copy-code-btn');
        // TÃ¬m input chá»©a meeting code Ä‘á»ƒ select text khi copy
        const input = document.getElementById('meeting-code-input');

        // 2. ÄÄ‚NG KÃ EVENT LISTENER CHO BUTTON CLICK
        // Khi user click button copy â†’ execute callback function
        btn.addEventListener('click', () => {

            // 3. SELECT TEXT TRONG INPUT
            // Highlight toÃ n bá»™ text trong input field (required Ä‘á»ƒ copy)
            // Visual: text sáº½ Ä‘Æ°á»£c highlight mÃ u xanh
            input.select();

            // 4. COPY TEXT ÄÃƒ SELECTED VÃ€O CLIPBOARD
            // Sá»­ dá»¥ng legacy API Ä‘á»ƒ copy text Ä‘Ã£ selected
            // Return: true (success) hoáº·c false (failed)
            document.execCommand('copy');

            // 5. UI FEEDBACK - THAY Äá»”I TEXT BUTTON
            // Thay Ä‘á»•i text button ngay láº­p tá»©c Ä‘á»ƒ user biáº¿t copy thÃ nh cÃ´ng
            // Visual: [Copy mÃ£ phÃ²ng] â†’ [ÄÃ£ copy!]
            btn.textContent = 'ÄÃ£ copy!';

            // 6. RESET BUTTON TEXT SAU 2 GIÃ‚Y
            // Sau 2000ms (2 giÃ¢y) â†’ reset button vá» text ban Ä‘áº§u
            // Visual: [ÄÃ£ copy!] â†’ wait 2s â†’ [Copy mÃ£ phÃ²ng]
            setTimeout(() => btn.textContent = 'Copy mÃ£ phÃ²ng', 2000);
        });

        // Reset tráº¡ng thÃ¡i cÃ¡c nÃºt sidebar khi load trang
        const qualityBtn = document.getElementById('toggle-quality');
        const recordingBtn = document.getElementById('toggle-recording');
        const statsBtn = document.getElementById('toggle-stats');
        const chatBtn = document.getElementById('toggle-chat');

        if (qualityBtn) {
            qualityBtn.innerHTML = 'âš™ï¸ Cháº¥t lÆ°á»£ng';
            qualityBtn.classList.remove('active');
        }

        if (recordingBtn) {
            recordingBtn.innerHTML = 'ğŸ¥ Ghi hÃ¬nh';
            recordingBtn.classList.remove('active');
        }

        if (statsBtn) {
            statsBtn.innerHTML = 'ğŸ“Š Xem thá»‘ng kÃª';
            statsBtn.classList.remove('active');
        }

        if (chatBtn) {
            chatBtn.innerHTML = 'ğŸ’¬ Chat';
            chatBtn.classList.remove('active');
        }

        // Äáº£m báº£o cÃ¡c sidebar Ä‘á»u Ä‘Ã³ng khi load trang
        const qualitySidebar = document.getElementById('quality-sidebar');
        const recordingSidebar = document.getElementById('recording-sidebar');
        const statsSidebar = document.getElementById('stats-sidebar');
        const chatSidebar = document.getElementById('chat-sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        if (qualitySidebar) qualitySidebar.classList.remove('open');
        if (recordingSidebar) recordingSidebar.classList.remove('open');
        if (statsSidebar) statsSidebar.classList.remove('open');
        if (chatSidebar) chatSidebar.classList.remove('open');
        if (overlay) overlay.classList.remove('show');

        // Khá»Ÿi táº¡o há»‡ thá»‘ng video call, quality control, recording, ... sau 0.5s
        setTimeout(() => {
            // Khá»Ÿi táº¡o video call
            if (typeof initializeVideoCall === 'function') {
                initializeVideoCall().then(() => {
                    console.log('âœ… Video Call System initialized');
                }).catch(error => {
                    console.error('âŒ Failed to initialize video call:', error);
                });
            }

            // Khá»Ÿi táº¡o quality control
            if (typeof initializeQualityControl === 'function') {
                window.qualityController = initializeQualityControl();

                // Káº¾T Ná»I Vá»šI VIDEO CALL SYSTEM
                if (typeof setQualityController === 'function') {
                    setQualityController(window.qualityController);
                    console.log('ğŸ”— Quality Control connected to Video Call System');
                }

                console.log('âœ… Quality Control System initialized');
            }

            // Khá»Ÿi táº¡o recording system
            if (typeof initializeRecordingSystem === 'function') {
                window.recordingSystem = initializeRecordingSystem();
                console.log('âœ… Recording System initialized');
            }

            // Khá»Ÿi táº¡o chat sidebar
            if (typeof ChatSidebar !== 'undefined') {
                window.chatSidebar = new ChatSidebar();
                console.log('âœ… Chat Sidebar initialized');
            } else {
                console.error('âŒ ChatSidebar class not found');
            }

            // Khá»Ÿi táº¡o subtitle system
            if (typeof SubtitleSystem !== 'undefined') {
                window.subtitleSystem = new SubtitleSystem();
                console.log('âœ… Subtitle System initialized');
            } else {
                console.error('âŒ SubtitleSystem class not found');
            }
        }, 500);
    });
</script>

<!-- Script chÃ­nh cho video call (pháº£i load Ä‘áº§u tiÃªn) -->
<script src="~/js/videocall.js"></script>

<!-- Script Ä‘iá»u khiá»ƒn cháº¥t lÆ°á»£ng video -->
<script src="~/js/quality-control.js"></script>

<!-- Script ghi hÃ¬nh & chá»¥p áº£nh -->
<script src="~/js/recording-system.js"></script>

<!-- Script sidebar thá»‘ng kÃª -->
<script src="~/js/stats-sidebar.js"></script>

<!-- Chat Panel System -->
<script src="~/js/chat-panel.js"></script>
<script src="~/js/chat-sidebar.js"></script>

<!-- Whiteboard System -->
<link href="~/css/components/whiteboard.css" rel="stylesheet" />
<script src="~/js/whiteboard.js"></script>

<!-- Real-time Subtitle System -->
<script src="~/js/subtitle-system.js"></script>
}