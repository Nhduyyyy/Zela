@{
    ViewData["Title"] = "Video Call Room";
}

<link href="~/css/pages/room-videocall.css" rel="stylesheet" />
<style>
    .host-badge {
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 10px;
        box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        animation: glow 2s ease-in-out infinite alternate;
    }
    
    .participant-badge {
        background: linear-gradient(135deg, #4a90e2, #357abd);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 10px;
        box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
    }
    
    @@keyframes glow {
        from { box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3); }
        to { box-shadow: 0 4px 8px rgba(255, 215, 0, 0.6); }
    }
</style>

<div class="videocall-container">
    <h2>üé• Ph√≤ng h·ªçp: @ViewBag.meetingName 
        @if (ViewBag.IsHost == true)
        {
            <span class="host-badge">üëë Host</span>
        }
        else
        {
            <span class="participant-badge">üë§ Tham gia</span>
        }
    </h2>
    
    <div class="meeting-code-container">
        <input type="text" id="meeting-code-input" value="@ViewBag.code" readonly>
        <button id="copy-code-btn">Copy m√£ ph√≤ng</button>
    </div>

    <div id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-message">ƒêang k·∫øt n·ªëi...</p>
        </div>
    </div>

    <div id="error-notification" style="display: none;">
        <div class="error-content">
            <span class="error-icon">‚ö†Ô∏è</span>
            <span class="error-message">C√≥ l·ªói x·∫£y ra</span>
            <button class="error-close">&times;</button>
        </div>
    </div>

    <div id="connection-status" class="connection-status connecting">
        <span class="status-icon">üîÑ</span>
        <span class="status-text">ƒêang k·∫øt n·ªëi...</span>
    </div>

    <div id="controls">
        <button id="toggle-mic" class="btn">üé§ Micro</button>
        <button id="toggle-cam" class="btn">üìπ Camera</button>
        <button id="share-screen" class="btn">üñ•Ô∏è Chia s·∫ª m√†n h√¨nh</button>
        <button id="toggle-quality" class="btn btn-info">‚öôÔ∏è Ch·∫•t l∆∞·ª£ng</button>
        <button id="toggle-recording" class="btn btn-success">üé• Ghi h√¨nh</button>
        @if (ViewBag.IsHost == true)
        {
            <button id="toggle-stats" class="btn btn-info">üìä Xem th·ªëng k√™</button>
        }
        <button id="btnLeave" class="btn" onclick="window.location.href='/Meeting'">üö™ R·ªùi ph√≤ng</button>
        @if (ViewBag.IsHost == true)
        {
            <button id="btnEnd" class="btn" onclick="if(confirm('B·∫°n c√≥ mu·ªën k·∫øt th√∫c cu·ªôc h·ªçp cho t·∫•t c·∫£ m·ªçi ng∆∞·ªùi?')) window.location.href='/Meeting'">üîö K·∫øt th√∫c cu·ªôc h·ªçp</button>
        }
    </div>

    <div id="video-grid" data-meeting-code="@ViewBag.code" data-user-id="@ViewBag.UserId"></div>

    <!-- Stats Sidebar -->
    <div id="stats-sidebar" class="stats-sidebar">
        <div class="sidebar-header">
            <h3>üìä Th·ªëng k√™ cu·ªôc h·ªçp</h3>
            <button id="close-stats" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="stats-loading" class="loading-spinner">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i th·ªëng k√™...</p>
            </div>
            <div id="stats-data" class="stats-data" style="display: none;">
                <!-- Stats content will be loaded here -->
            </div>
            <div id="stats-error" class="error-message" style="display: none;">
                <p>‚ùå Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™</p>
                <button id="retry-stats" class="btn btn-sm btn-primary">Th·ª≠ l·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Quality Control Sidebar -->
    <div id="quality-sidebar" class="stats-sidebar quality-sidebar">
        <div class="sidebar-header">
            <h3>‚öôÔ∏è Ch·∫•t l∆∞·ª£ng Video</h3>
            <button id="close-quality" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="quality-content">
                <!-- Quality control content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Recording Sidebar -->
    <div id="recording-sidebar" class="stats-sidebar recording-sidebar">
        <div class="sidebar-header">
            <h3>üé• Ghi h√¨nh & Ch·ª•p ·∫£nh</h3>
            <button id="close-recording" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div id="recording-content">
                <!-- Recording content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
</div>

@section Scripts {
    @* SignalR already loaded in _Layout.cshtml *@
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script>
        // Set global variables for recording system
        window.meetingCode = '@ViewBag.code';
        window.currentUserId = @ViewBag.UserId;
        window.isHost = @(ViewBag.IsHost?.ToString().ToLower() ?? "false");
        
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('copy-code-btn');
            const input = document.getElementById('meeting-code-input');
            btn.addEventListener('click', () => {
                input.select();
                document.execCommand('copy');
                btn.textContent = 'ƒê√£ copy!';
                setTimeout(() => btn.textContent = 'Copy m√£ ph√≤ng', 2000);
            });

            // Reset button states on page load
            const qualityBtn = document.getElementById('toggle-quality');
            const recordingBtn = document.getElementById('toggle-recording');
            const statsBtn = document.getElementById('toggle-stats');
            
            if (qualityBtn) {
                qualityBtn.innerHTML = '‚öôÔ∏è Ch·∫•t l∆∞·ª£ng';
                qualityBtn.classList.remove('active');
            }
            
            if (recordingBtn) {
                recordingBtn.innerHTML = 'üé• Ghi h√¨nh';
                recordingBtn.classList.remove('active');
            }
            
            if (statsBtn) {
                statsBtn.innerHTML = 'üìä Xem th·ªëng k√™';
                statsBtn.classList.remove('active');
            }
            
            // Ensure all sidebars are closed initially
            const qualitySidebar = document.getElementById('quality-sidebar');
            const recordingSidebar = document.getElementById('recording-sidebar');
            const statsSidebar = document.getElementById('stats-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (qualitySidebar) qualitySidebar.classList.remove('open');
            if (recordingSidebar) recordingSidebar.classList.remove('open');
            if (statsSidebar) statsSidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');

            // Initialize video call system first
            setTimeout(() => {
                // Initialize video call system
                if (typeof initializeVideoCall === 'function') {
                    initializeVideoCall().then(() => {
                        console.log('‚úÖ Video Call System initialized');
                    }).catch(error => {
                        console.error('‚ùå Failed to initialize video call:', error);
                    });
                }
                
                // Initialize quality control system
                if (typeof initializeQualityControl === 'function') {
                    window.qualityController = initializeQualityControl();
                    console.log('‚úÖ Quality Control System initialized');
                }
                
                // Initialize recording system
                if (typeof initializeRecordingSystem === 'function') {
                    window.recordingSystem = initializeRecordingSystem();
                    console.log('‚úÖ Recording System initialized');
                }
            }, 500);
        });
    </script>
    
    <!-- Main video call script - Load FIRST -->
    <script src="~/js/videocall.js"></script>
    
    <!-- Quality Control System -->
    <script src="~/js/quality-control.js"></script>
    
    <!-- Recording & Screenshots System -->
    <script src="~/js/recording-system.js"></script>
    
    <!-- Stats Sidebar System -->
    <script src="~/js/stats-sidebar.js"></script>
}