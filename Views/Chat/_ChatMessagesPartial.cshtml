@model List<Zela.ViewModels.MessageViewModel>
@foreach (var msg in Model)
{
    <div class="message @(msg.IsMine ? "right" : "left")" data-message-id="@msg.MessageId">
        @if (msg.IsMine)
        {
            <!-- Người GỬI: thời gian -> reply -> media -> nút reply (trái) + bubble (phải) -->
            <div class="message-content">
                <span class="message-time">@msg.SentAt.ToString("HH:mm")</span>
                @if (msg.ReplyToMessageId != null)
                {
                    <div class="reply-preview-in-bubble">
                        <span class="reply-preview-sender">@msg.ReplyToMessageSenderName</span>
                        <span class="reply-preview-content">@msg.ReplyToMessageContent</span>
                    </div>
                }
                <div style="display: flex; align-items: flex-start; gap: 6px;">
                    <button class="btn-reply-message" data-message-id="@msg.MessageId" data-message-content="@msg.Content" data-message-sender="@msg.SenderName" title="Trả lời">
                        <i class="bi bi-reply"></i>
                    </button>
                    @if (!string.IsNullOrEmpty(msg.StickerUrl))
                    {
                        <img src="@msg.StickerUrl" class="sticker-message" alt="Sticker"/>
                    }
                    else if (!string.IsNullOrWhiteSpace(msg.Content) && msg.Content != "[Đã gửi file]")
                    {
                        <span class="message-bubble">@msg.Content</span>
                    }
                </div>
                @if (msg.Media != null && msg.Media.Count > 0)
                {
                    foreach (var media in msg.Media)
                    {
                        var isTextDoc = media.FileName != null && (media.FileName.EndsWith(".txt") || 
                                                                   media.FileName.EndsWith(".doc") || 
                                                                   media.FileName.EndsWith(".docx"));
                        if (media.MediaType != null && media.MediaType.StartsWith("image/"))
                        {
                            <img src="@media.Url" class="message-media-img" alt="Ảnh gửi"/>
                        }
                        else if (media.MediaType != null && media.MediaType.StartsWith("video/"))
                        {
                            <video src="@media.Url" class="message-media-video" controls></video>
                        }
                        else if (isTextDoc)
                        {
                            <div class="file-block file-summary-block" data-media-url="@media.Url" data-filename="@media.FileName">
                                <div class="chat-file-attachment-group">
                                    <div class="chat-file-attachment">
                                        <span class="file-icon"><i class="bi bi-file-earmark-text"></i></span>
                                        <span class="file-name">@media.FileName</span>
                                        <a href="@media.Url" download="@media.FileName" class="file-download-btn" title="Tải về"><i class="bi bi-download"></i></a>
                                    </div>
                                    <div class="chat-file-attachment">
                                        <button type="button" class="btn btn-primary btn-preview-file" data-media-url="@media.Url" data-filename="@media.FileName">
                                            Xem trước
                                        </button>
                                        <button type="button" class="btn btn-primary btn-summarize-file" data-media-url="@media.Url" data-filename="@media.FileName">
                                            <span class="btn-summarize-text">Tóm tắt file</span>
                                            <span class="btn-summarize-loading" style="display:none;">
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang tóm tắt...
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                @* preview-block *@
                                <div class="file-preview-content" style="display:none;"></div>
                                @* summary-block *@
                                <div class="file-summary-content" style="display:none;"></div>
                            </div>
                        }
                        else
                        {
                            <div class="chat-file-attachment">
                                <span class="file-icon"><i class="bi bi-file-earmark"></i></span>
                                <span class="file-name">@media.FileName</span>
                                <a href="@media.Url" download="@media.FileName" class="file-download-btn" title="Tải về"><i class="bi bi-download"></i></a>
                            </div>
                        }
                    }
                }
                <span class="messsage-status">@msg.StatusText</span>
            </div>
        }
        else
        {
            <!-- Người NHẬN: avatar -> media -> bubble (trái) + nút reply (phải) -> thời gian -->
            <img src="@msg.AvatarUrl" class="message-avatar" />
            <div class="message-content">
                <span class="message-time">@msg.SentAt.ToString("HH:mm")</span>
                @if (msg.ReplyToMessageId != null)
                {
                    <div class="reply-preview-in-bubble">
                        <span class="reply-preview-sender">@msg.ReplyToMessageSenderName</span>
                        <span class="reply-preview-content">@msg.ReplyToMessageContent</span>
                    </div>
                }
                <div style="display: flex; align-items: flex-start; gap: 6px;">
                    @if (!string.IsNullOrEmpty(msg.StickerUrl))
                    {
                        <img src="@msg.StickerUrl" class="sticker-message" alt="Sticker" draggable="false" />
                    }
                    else if (!string.IsNullOrWhiteSpace(msg.Content) && msg.Content != "[Đã gửi file]")
                    {
                        <span class="message-bubble">@msg.Content</span>
                    }
                    <button class="btn-reply-message" data-message-id="@msg.MessageId" data-message-content="@msg.Content" data-message-sender="@msg.SenderName" title="Trả lời">
                        <i class="bi bi-reply"></i>
                    </button>
                </div>
                @if (msg.Media != null && msg.Media.Count > 0)
                {
                    foreach (var media in msg.Media)
                    {
                        var isTextDoc = media.FileName != null && (media.FileName.EndsWith(".txt") || 
                                                                   media.FileName.EndsWith(".doc") || 
                                                                   media.FileName.EndsWith(".docx"));
                        if (media.MediaType != null && media.MediaType.StartsWith("image/"))
                        {
                            <img src="@media.Url" class="message-media-img" alt="Ảnh gửi"/>
                        }
                        else if (media.MediaType != null && media.MediaType.StartsWith("video/"))
                        {
                            <video src="@media.Url" class="message-media-video" controls></video>
                        }
                        else if (isTextDoc)
                        {
                            <div class="file-block file-summary-block" data-media-url="@media.Url" data-filename="@media.FileName">
                                <div class="chat-file-attachment-group">
                                    <div class="chat-file-attachment">
                                        <span class="file-icon"><i class="bi bi-file-earmark-text"></i></span>
                                        <span class="file-name">@media.FileName</span>
                                        <a href="@media.Url" download="@media.FileName" class="file-download-btn" title="Tải về"><i class="bi bi-download"></i></a>
                                    </div>
                                    <div class="chat-file-attachment">
                                        <button type="button" class="btn btn-primary btn-preview-file" data-media-url="@media.Url" data-filename="@media.FileName">
                                            Xem trước
                                        </button>
                                        <button type="button" class="btn btn-primary btn-summarize-file" data-media-url="@media.Url" data-filename="@media.FileName">
                                            <span class="btn-summarize-text">Tóm tắt file</span>
                                            <span class="btn-summarize-loading" style="display:none;">
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang tóm tắt...
                                        </span>
                                        </button>
                                    </div>
                                </div>
                                @* preview-block *@
                                <div class="file-preview-content" style="display:none;"></div>
                                @* summary-block *@
                                <div class="file-summary-content" style="display:none;"></div>
                            </div>
                        }
                        else
                        {
                            <div class="chat-file-attachment">
                                <span class="file-icon"><i class="bi bi-file-earmark"></i></span>
                                <span class="file-name">@media.FileName</span>
                                <a href="@media.Url" download="@media.FileName" class="file-download-btn" title="Tải về"><i class="bi bi-download"></i></a>
                            </div>
                        }
                    }
                }
            </div>
        }
    </div>
}