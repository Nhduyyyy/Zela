@model Zela.Models.Media
@{
    ViewData["Title"] = "Chi tiết File";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="admin-page-title">
                <i class="bi bi-file-earmark me-2"></i>Chi tiết File
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Admin">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/Admin/Files">File/Media</a></li>
                    <li class="breadcrumb-item active">@Model.MediaId</li>
                </ol>
            </nav>
        </div>
        <div class="admin-actions">
            <a href="/Admin/Files" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Quay lại
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- File Preview -->
    <div class="col-md-8">
        <div class="file-detail-card">
            <h5 class="mb-3"><i class="bi bi-eye me-2"></i>Xem trước</h5>
            
            <div class="file-preview-large">
                @if (Model.MediaType?.StartsWith("image") == true)
                {
                                         <img src="@Model.Url" alt="@Model.MediaId" class="img-fluid rounded">
                }
                else if (Model.MediaType?.StartsWith("video") == true)
                {
                    <video controls class="w-100 rounded">
                        <source src="@Model.Url" type="@Model.MediaType">
                        Trình duyệt không hỗ trợ video này.
                    </video>
                }
                else if (Model.MediaType?.StartsWith("audio") == true)
                {
                    <div class="audio-player">
                        <audio controls class="w-100">
                            <source src="@Model.Url" type="@Model.MediaType">
                            Trình duyệt không hỗ trợ audio này.
                        </audio>
                    </div>
                }
                else
                {
                    <div class="file-preview-placeholder">
                        <div class="file-icon-large">
                            <i class="bi bi-file-earmark"></i>
                        </div>
                        <p class="mt-3">Không thể xem trước file này</p>
                        <a href="@Model.Url" target="_blank" class="btn btn-primary">
                            <i class="bi bi-download me-1"></i>Tải xuống để xem
                        </a>
                    </div>
                }
            </div>
            
            <div class="file-actions-bar">
                <a href="@Model.Url" target="_blank" class="btn btn-success">
                    <i class="bi bi-download me-1"></i>Tải xuống
                </a>
                                 <button class="btn btn-danger" onclick="deleteFile('@Model.MediaId', '@Model.MediaId')">
                    <i class="bi bi-trash me-1"></i>Xóa file
                </button>
            </div>
        </div>
    </div>

    <!-- File Information -->
    <div class="col-md-4">
        <div class="file-detail-card">
            <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Thông tin file</h5>
            
            <div class="file-info-list">
                                 <div class="info-item">
                     <label>ID:</label>
                     <span>@Model.MediaId</span>
                 </div>
                <div class="info-item">
                    <label>Loại file:</label>
                    <span class="file-type-badge">@Model.MediaType</span>
                </div>
                <div class="info-item">
                    <label>URL:</label>
                    <span class="url-text">@Model.Url</span>
                </div>
                <div class="info-item">
                    <label>Ngày upload:</label>
                    <span>@Model.UploadedAt.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
                @if (Model.Message?.Sender != null)
                {
                    <div class="info-item">
                        <label>Người upload:</label>
                        <div class="uploader-info">
                            <img src="@(Model.Message.Sender.AvatarUrl ?? "/images/default-avatar.jpeg")" 
                                 alt="@Model.Message.Sender.FullName" 
                                 class="uploader-avatar">
                            <div>
                                <div class="fw-semibold">@Model.Message.Sender.FullName</div>
                                <small class="text-muted">@Model.Message.Sender.Email</small>
                            </div>
                        </div>
                    </div>
                }
                @if (Model.Message != null)
                {
                    <div class="info-item">
                        <label>Tin nhắn:</label>
                        <div class="message-content">
                            @if (!string.IsNullOrEmpty(Model.Message.Content))
                            {
                                <p>@Model.Message.Content</p>
                            }
                            else
                            {
                                <p class="text-muted fst-italic">Không có nội dung tin nhắn</p>
                            }
                            <small class="text-muted">@Model.Message.SentAt.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- File Summary (if available) -->
        @if (ViewBag.FileSummary != null)
        {
            <div class="file-detail-card">
                <h5 class="mb-3"><i class="bi bi-file-text me-2"></i>Tóm tắt file</h5>
                <div class="file-summary">
                    <p>@ViewBag.FileSummary.Summary</p>
                    <small class="text-muted">
                        Tạo lúc: @ViewBag.FileSummary.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                    </small>
                </div>
            </div>
        }
    </div>
</div>

@Html.Partial("_FileActionModals")

<style>
.file-detail-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.file-preview-large {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.file-preview-placeholder {
    text-align: center;
    color: #6c757d;
}

.file-icon-large {
    font-size: 64px;
    color: #dee2e6;
}

.audio-player {
    width: 100%;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
}

.file-actions-bar {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.file-info-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.info-item {
    border-bottom: 1px solid #f8f9fa;
    padding-bottom: 12px;
}

.info-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.info-item label {
    font-weight: 600;
    color: #6c757d;
    font-size: 14px;
    display: block;
    margin-bottom: 4px;
}

.info-item span {
    color: #212529;
    word-break: break-all;
}

.file-type-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.url-text {
    font-family: monospace;
    font-size: 12px;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}

.uploader-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.uploader-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.message-content {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.file-summary {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}
</style>

@section Scripts {
    <script>
        function deleteFile(fileId, fileName) {
            if (confirm(`Bạn có chắc chắn muốn xóa file "${fileName}"? Hành động này không thể hoàn tác!`)) {
                const reason = prompt('Lý do xóa file:');
                if (reason !== null) {
                    fetch('/Admin/DeleteFile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({ fileId: fileId, reason: reason })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Đã xóa file thành công!');
                            window.location.href = '/Admin/Files';
                        } else {
                            alert('Lỗi: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi xóa file');
                    });
                }
            }
        }
    </script>
} 